ServletRequestAttributes attrs = ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes());
final HttpServletRequest request = attrs.getRequest(); // 必须在servlet请求上下文中获取
final Predicate<String> isIpUnknown = ip -> ip == null || ip.isEmpty() || "unknown".equalsIgnoreCase(ip);
String ipAddress = request.getHeader("X-Forwarded-For");
if (isIpUnknown.test(ipAddress)) {
    ipAddress = request.getHeader("Proxy-Client-IP");
}
if (isIpUnknown.test(ipAddress)) {
    ipAddress = request.getHeader("WL-Proxy-Client-IP");
}
if (isIpUnknown.test(ipAddress)) {
    ipAddress = request.getHeader("HTTP_CLIENT_IP");
}
if (isIpUnknown.test(ipAddress)) {
    ipAddress = request.getHeader("HTTP_X_FORWARDED_FOR");
}
if (isIpUnknown.test(ipAddress)) {
    ipAddress = request.getRemoteAddr();
}
if (isIpUnknown.test(ipAddress)) {
    throw new RuntimeException("客户端ip获取失败");
}
// 对于通过多个代理的情况，第一个IP为客户端真实IP,多个IP按照','分割
if (ipAddress.length() > 15 && ipAddress.contains(",")) { // "***.***.***.***".length()
    // = 15
    ipAddress = ipAddress.substring(0, ipAddress.indexOf(","));
}
System.out.println(ipAddress);